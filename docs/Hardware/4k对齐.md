# 4k对齐

参考：

https://www.diskgenius.cn/exp/about-4k-alignment.php

## 物理扇区 vs 逻辑扇区

硬盘的基本读写单位是"[扇区](../../../Hardware/文件系统)"

- 物理扇区：随着硬盘容量的要求不断增加，出现了扇区大小为4096字节的硬盘。这样的大扇区被我们称为“物理扇区”
- 逻辑扇区：但是这样的大扇区会有兼容问题，有的系统或软件无法适应。==硬盘内部将物理扇区在逻辑上划分为多个扇区片段并将其做为普通扇区==(一般为512byte，接受指令的最小操作单元)报告给操作系统机软件。这样的扇区片段被我们称为“逻辑扇区”。==我们通常说的扇区一般指逻辑扇区==

实际读写时由硬盘内的固件负责逻辑扇区于物理扇区之间进行转换，上层程序感觉不到物理扇区的存在。

## 簇

格式化是对分区范围内扇区的使用进行规划，划分固定大小的簇。==格式化后分区就会以簇为最小单位读写，文件得数据，属性等信息都会保存到簇中==。

<img src="...\..\..\..\imgs\_Hardware\v2-328652ba4b107448ba4703066fa10255_720w.png"/>

## 4k对齐

为磁盘划分分区时，是以逻辑扇区为单位进行划分的，分区可以从任意编号的逻辑扇区开始。

一个物理扇区可以包含一个或多个逻辑扇区(比如多数硬盘的物理扇区包含8个逻辑扇区)。==当要读写某个逻辑扇区，硬盘底层在实际操作时都会读写逻辑扇区所在的整个物理扇区。==

如果分区的起始位置没有对齐到某个物理扇区的边缘。格式化后，所有的“簇”也无法对齐到物理扇区的边缘。==如果没有对齐，额外的工作会增加，造成读写性能下降==

![](D:\asset\note\imgs\_Linux\Snipaste_2021-03-15_11-13-58.png)

格式化后，每个簇占4个逻辑扇区，这些簇都没有对齐到物理扇区的边缘，也就是说每个簇都跨越了2个物理扇区。由于磁盘总是以物理扇区进行读写，在这种分区情况下，当要读取某个簇时，实际上总是需要多读取一个物理扇区的数据。比如要读取0号簇共4个逻辑扇区的数据，磁盘实际执行时，必须要读取0号和1号两个物理扇区共8个逻辑扇区的数据。同理，对“簇”的写入操作也是这样。显而易见，这样会造成读写性能的严重下降。

==在这样对齐的情况下，当要读取某个簇，磁盘实际执行时并不需要额外读取任何扇区，可以充分发挥磁盘的读写性能。显然这正是我们需要的。==

<font color="red">由此可见，对于物理扇区大小与逻辑扇区大小不一致的磁盘，分区4K对齐才能充分发挥磁盘的读写性能。而不对齐就会造成磁盘读写性能的下降。</font>

## 如何查看4k对齐

```
root in ~ λ fdisk -l
Disk /dev/vda: 40 GiB, 42949672960 bytes, 83886080 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x47a9c03f

Device     Boot Start      End  Sectors Size Id Type
/dev/vda1  *     2048 83886046 83883999  40G 83 Linux
```

这里可以看到逻辑扇区和物理扇区都为512bytes(这里可以判定4k对齐)，起始柱面(起始扇区)为2048，结束柱面(结束扇区)为83886046

```
root in ~ λ fdisk -l
Disk /dev/vda: 40 GiB, 42949672960 bytes, 83886080 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x47a9c03f

Device     Boot Start      End  Sectors Size Id Type
/dev/vda1  *     2048 83886046 83883999  40G 83 Linux
```

这里可以看到逻辑扇区为512bytes和物理扇区都为4096byes，==所以如果要4k对齐每个物理扇区要包含8个逻辑扇区(4096/512)或是8的倍数。所以起始扇区需要为8的倍数。==